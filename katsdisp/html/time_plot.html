<html>
<head>
<title>KAT7 signals</title> 
</head>
<body onload='myloadpage()' bgcolor="#FFFFFF">
	<script>
	function setflags(){
		var textflag= document.getElementById("textflag");
	 	var plot_str="setflags"+","+textflag.value;
	 	handle_user_event(plot_str,0);
		redrawCanvas()
		return;		
	}
	function settextchannelphase(){
	 	var textchannelphase=document.getElementById("textchannelphase");
	 	var plot_str="settextchannelphase"+","+textchannelphase.value;
	 	handle_user_event(plot_str,0);
		redrawCanvas()
	}
	function plot(){
	 var selcheckHH = document.getElementById("optionHH");
	 var selcheckVV = document.getElementById("optionVV");
	 var selcheckHV = document.getElementById("optionHV");
	 var selcheckVH = document.getElementById("optionVH");
	 var selchecklegend = document.getElementById("optionlegend");
	 var seltypemenu = document.getElementById("typemenu");
	 var textminF	= document.getElementById("textminF");
	 var textmaxF	= document.getElementById("textmaxF");
	 var textminx	= document.getElementById("textminx");
	 var textmaxx	= document.getElementById("textmaxx");
	 var texttimeavg= document.getElementById("texttimeavg");
	 var textchannelphase=document.getElementById("textchannelphase");
	 var plot_str="";
	 plot_str+=selcheckHH.checked+","
	 plot_str+=selcheckVV.checked+","
	 plot_str+=selcheckHV.checked+","
	 plot_str+=selcheckVH.checked+","
	 plot_str+=selchecklegend.checked+","
	 plot_str+=seltypemenu.options[seltypemenu.selectedIndex].value+","
	 plot_str+=textminF.value+","
	 plot_str+=textmaxF.value+","
	 plot_str+=""+","
	 plot_str+=textminx.value+","
	 plot_str+=textmaxx.value+","
	 plot_str+=""+","
	 plot_str+=""+","
	 plot_str+=""+","
	 plot_str+=""+","
	 plot_str+=texttimeavg.value+","
	 plot_str+=textchannelphase.value
	 handle_user_event(plot_str,0);
	 if (seltypemenu.selectedIndex<2)
	 {
		textchannelphase.disabled=true;
		textchannelphase.style.backgroundColor = "#EEEEEE";
	 }else 
	{
		textchannelphase.disabled=false;
		textchannelphase.style.backgroundColor = "#FFFFFF";
	}
		
	}
			var datafile='<!--datafile-->'
			var antbase0=[];
			var antbase1=[];
			var antennamappingmode=<!--antennamappingmode-->
			var antposx=<!--antposx-list-->
			var antposy=<!--antposy-list-->
			var antdisp=<!--antdisp-list-->
			var antposminx=1e30;
			var antposminy=1e30;
			var antposmaxx=-1e30;
			var antposmaxy=-1e30;
			var nvalidant=0
			for (i=0;i<antposx.length;i++)
			{
				if (!antdisp[i])continue;
				if (antposx[i]<antposminx)antposminx=antposx[i];
				if (antposx[i]>antposmaxx)antposmaxx=antposx[i];
				if (antposy[i]<antposminy)antposminy=antposy[i];
				if (antposy[i]>antposmaxy)antposmaxy=antposy[i];
				nvalidant++;
			}
			if (nvalidant>1)
			for (i=0;i<antposx.length;i++)
			{
				antposx[i]=(antposx[i]-antposminx)/(antposmaxx-antposminx)*100+6+5;
				antposy[i]=(1-(antposy[i]-antposminy)/(antposmaxy-antposminy))*100+6;
			}else
			for(i=0;i<antposx.length;i++)
			{
				antposx[i]=50;
				antposy[i]=50;
			}
			var antdown=-1;
			var antup=-1;
			
			function myloadpage(){
				connect_manager();
				redrawlineCanvas()
				document.getElementById("healthtext").innerHTML=datafile;
				if (datafile!='stream')
				{
					document.getElementById("nextchunkid").style.display='inline';
					document.getElementById("prevchunkid").style.display='inline';
				}else
				{
					document.getElementById("nextchunkid").style.display='none';
					document.getElementById("prevchunkid").style.display='none';
				}
				if (antennamappingmode==0)
				{
				 document.getElementById("HHtext").innerHTML="XX";
				 document.getElementById("VVtext").innerHTML="YY";
				 document.getElementById("HVtext").innerHTML="XY";
				 document.getElementById("VHtext").innerHTML="YX";					
				}
			//beginloadpage
			//endloadpage
		 	var seltypemenu = document.getElementById("typemenu");
		 	var textchannelphase=document.getElementById("textchannelphase");
			 if (seltypemenu.selectedIndex<2)
			 {
				textchannelphase.disabled=true;
				textchannelphase.style.backgroundColor = "#EEEEEE";
			 }else 
			{
				textchannelphase.disabled=false;
				textchannelphase.style.backgroundColor = "#FFFFFF";
			}
			}
			function redrawlineCanvas(){
				var drawingCanvas = document.getElementById('canvasThick');
				if(drawingCanvas.getContext) {
				var context = drawingCanvas.getContext('2d');
				context.fillStyle = "#FFFFFF";
				context.fillRect(0, 0, 24, 10);
				context.strokeStyle = "#000000";
				context.fillStyle = "#000000";
				context.lineWidth   = 2
				context.moveTo(2,5);
				context.lineTo(22,5);
				context.stroke()
				}
				drawingCanvas = document.getElementById('canvasThin');
				if(drawingCanvas.getContext) {
				var context = drawingCanvas.getContext('2d');
				context.fillStyle = "#FFFFFF";
				context.fillRect(0, 0, 24, 10);
				context.strokeStyle = "#000000";
				context.fillStyle = "#000000";
				context.lineWidth   = 1
				context.moveTo(2,5);
				context.lineTo(22,5);
				context.stroke()
				}
				drawingCanvas = document.getElementById('canvasDash');
				if(drawingCanvas.getContext) {
				var context = drawingCanvas.getContext('2d');
				context.fillStyle = "#FFFFFF";
				context.fillRect(0, 0, 24, 10);
				context.strokeStyle = "#000000";
				context.fillStyle = "#000000";
				context.lineWidth   = 1
				context.moveTo(2,5);
				context.lineTo(7,5);
				context.moveTo(9,5);
				context.lineTo(14,5);
				context.moveTo(16,5);
				context.lineTo(21,5);
				context.stroke()
				}
				drawingCanvas = document.getElementById('canvasDot');
				if(drawingCanvas.getContext) {
				var context = drawingCanvas.getContext('2d');
				context.fillStyle = "#FFFFFF";
				context.fillRect(0, 0, 24, 10);
				context.strokeStyle = "#000000";
				context.fillStyle = "#000000";
				context.lineWidth   = 1
				context.moveTo(3,5);
				context.lineTo(5,5);
				context.moveTo(7,5);
				context.lineTo(9,5);
				context.moveTo(11,5);
				context.lineTo(13,5);
				context.moveTo(15,5);
				context.lineTo(17,5);
				context.moveTo(19,5);
				context.lineTo(21,5);
				context.stroke()
				}
				return
			}
			function redrawCanvas(){
			var colourlistR=<!--colour-list-R>
			var colourlistG=<!--colour-list-G>
			var colourlistB=<!--colour-list-B>
			var drawingCanvas = document.getElementById('antennaCanvas');
			if(drawingCanvas.getContext) {
			var context = drawingCanvas.getContext('2d');
			context.fillStyle = "#FFFFFF";
			context.fillRect(0, 0, 150, 150);
			context.font="12px sans-serif";
			context.strokeStyle = "#000000";
			context.fillStyle = "#000000";
			for (i=0;i<antposx.length;i++)
			{
				if (!antdisp[i])continue;
				context.beginPath();
				context.arc(antposx[i],antposy[i],5,0,Math.PI*2,true);
				context.closePath();
				context.stroke();
			}
			for (i=0;i<antbase0.length;i++)
			{
				RR=Math.floor((colourlistR[antbase0[i]]+colourlistR[antbase1[i]])/2)
				GG=Math.floor((colourlistG[antbase0[i]]+colourlistG[antbase1[i]])/2)
				BB=Math.floor((colourlistB[antbase0[i]]+colourlistB[antbase1[i]])/2)
				usecolour="rgba("+RR+","+GG+","+BB+", 1)"
				context.strokeStyle = usecolour;
				context.beginPath();
				if (antbase0[i]==antbase1[i])
				{
					context.lineWidth   = 1
					context.fillStyle=usecolour;
					context.arc(antposx[antbase0[i]],antposy[antbase1[i]],5,0,Math.PI*2,true);
				}else
				{
					context.lineWidth   = 2
					context.moveTo(antposx[antbase0[i]],antposy[antbase0[i]]);
					context.lineTo(antposx[antbase1[i]],antposy[antbase1[i]]);
				}
				context.closePath();
				context.stroke();
				context.fill();
			}
			context.lineWidth   = 1
			context.fillStyle="#000000"
			for (i=0;i<antposx.length;i++)
			{
				if (!antdisp[i])continue;
				context.fillText(i+antennamappingmode,antposx[i]-3,antposy[i]+15);
			}
			}
			}
			function onMouseDown(event){
				antup=-1;
				for (i=0;i<antposx.length;i++)
				{
					if (!antdisp[i])continue;
					if ((antposx[i]-event.offsetX)*(antposx[i]-event.offsetX)+(antposy[i]-event.offsetY)*(antposy[i]-event.offsetY)<5*5)
					{
						antdown=i;
						return;
					}
				}
/*				for (i=0;i<antposx.length;i++)
				{
					for (j=0;j<i;j++)
					{
						//see if this baseline is selected or not
						if (event.offsetX>antposx[i] && event.offsetX<antposx[j] || )
						
						if (event.offsetX-antposx[i])/(event.offsetY-antposy[i])==(antposx[j]-antposx[i])/(antposy[j]-antposy[i])
					}
				}*/
				antdown=-1;
				return;
			}
			function toggleBaseline(ant0,ant1){
				if (ant1<ant0)
				{
					var ant=ant1;
					ant1=ant0;
					ant0=ant;
				}
				var removed=false;
				for(i=0;i<antbase0.length;i++)
				{
					if ((ant0==antbase0[i]&&ant1==antbase1[i]) || (ant1==antbase0[i]&&ant0==antbase1[i]))
					{
						antbase0.splice(i,1);
						antbase1.splice(i,1);
						removed=true;
						break;
					}
				}
				if (!removed)
				{
				   antbase0[antbase0.length]=ant0;
				   antbase1[antbase1.length]=ant1;
			    }
			 	var plot_str="setbaseline"+",";
				for (j=0;j<antbase0.length;j++)
				{
					plot_str+=antbase0[j]+","
					plot_str+=antbase1[j]+","
				}
			 	handle_user_event(plot_str,0);
				redrawCanvas()
				return;
			}
			function addBaseline(ant0,ant1,doaddbaseline){
				if (ant1<ant0)
				{
					var ant=ant1;
					ant1=ant0;
					ant0=ant;
				}
				if (doaddbaseline)
				{
				for(ii=0;ii<antbase0.length;ii++)
				{
					if ((ant0==antbase0[ii]&&ant1==antbase1[ii]) || (ant1==antbase0[ii]&&ant0==antbase1[ii]))
					{
						return;//already in list
					}
				}
				if (ii==antbase0.length)
				{
				   antbase0[antbase0.length]=ant0;
				   antbase1[antbase1.length]=ant1;
			    }
				}else
				{
					for(ii=0;ii<antbase0.length;ii++)
					{
						if ((ant0==antbase0[ii]&&ant1==antbase1[ii]) || (ant1==antbase0[ii]&&ant0==antbase1[ii]))
						{
							antbase0.splice(ii,1);
							antbase1.splice(ii,1);
							return;//already in list
						}
					}
				}
				return;
			}
			function safeAddBaseline(ant0,ant1,doaddbaseline){
				rv=[]
				if (ant0<0||ant0>=antdisp.length||!antdisp[ant0]) rv[rv.length]=ant0;
				if (ant1<0||ant1>=antdisp.length||!antdisp[ant1]) rv[rv.length]=ant1;
				if (rv.length) return rv;
				addBaseline(ant0,ant1,doaddbaseline)
				return rv;
			}
			function selectClear(){
				antbase0=[];
				antbase1=[];
			 	var plot_str="setbaseline"+",";
			 	handle_user_event(plot_str,0);
				redrawCanvas()
			}
			function selectBaseline(){
				var textbaseline= document.getElementById("textselectbaseline");
				//first convert , to ; if inside brackets and convert - to items separated by ; also remove brackets also remove spaces
				var txt=textbaseline.value;
				var newtxt=''
				var inbrack=0;
				
				for (i=0;i<txt.length;i++)
				{
					if (txt[i]==' ')continue;
					if (txt[i]=='(')
					{
						if (inbrack)
						{
							alert('Nested brackets not allowed')
							return;
						}
						inbrack=1;
					}else
					if (txt[i]==')')
					{
						if (inbrack)
						{
							inbrack=0;
						}else
						{
							alert('Unexpected )')
							return;
						}
					}else
					if (inbrack)
					{
						if (txt[i]==',')
						{
							newtxt+=';'
						}else if (txt[i]=='.'&&(i+1)<txt.length&&txt[i+1]=='.')//..
						{
							//try determine range values
							valt0=''
							for (j=i-1;j>0;j--)
							{
								if (txt[j].split(/\d/).length!=2) break
								valt0=''+txt[j]+valt0;
							}
							if (valt0=='') val0=0
							else val0=valt0.valueOf()-antennamappingmode;
							valt1=''
							i++;
							for (j=i+1;j<txt.length;j++)
							{
								if (txt[j].split(/\d/).length!=2) break
								valt1+=txt[j];
							}
							if (valt1=='') val1=antposx.length-1;
							else val1=valt1.valueOf()-antennamappingmode;
							if (valt0=='')
								newtxt+=(val0+antennamappingmode);
							for (j=val0+1;j<val1;j++)
								newtxt+=';'+(j+antennamappingmode);
							if (valt1=='')
								newtxt+=';'+(val1+antennamappingmode);
							else newtxt+=';';
						}else newtxt+=txt[i]
					}else if (txt[i]==';')
					{
						newtxt+=',';
					}else newtxt+=txt[i];
				}
				var baselines=newtxt.split(',');
				var val,val0,val1;
				if (baselines=='')	return
				
				//eg 3,4,5,8..11,3x5,4x, !3,!3..5,!3x
				//autocorrelations 3,4,5,8..11
				//specific cross correlations 3x5
				//cross correlations to all other antennas 4x
				for (i=0;i<baselines.length;i++)
				{
					var doaddbaseline=0;
					var termremainder=baselines[i].split('!');
					if (termremainder.length!=2){
						doaddbaseline=1
						termremainder=baselines[i];
					}else{
						if (termremainder[0]=='')
							termremainder=termremainder[1]
						else termremainder=termremainder[0]
					}
					var term=termremainder.split('..');
					if (term.length==1)//not range
					{
						var xterm=termremainder.split('x');
						if (xterm.length==1)//eg 3
						{
							scterm=termremainder.split(';')
							for (sc=0;sc<scterm.length;sc++)
							{
								val=scterm[sc].valueOf()-antennamappingmode;
								if (val>=0&&val<antposx.length)
								{
									safeAddBaseline(val,val,doaddbaseline);
								}else alert(''+(val+antennamappingmode)+' is not a valid antenna number')
							}
						}else if(xterm.length==2)
						{
							if (xterm[1]=='')
							{//then all cross correlations of xterm[0]
								if (xterm[0]=='')
								{//then all cross correlations
									for (k=0;k<antposx.length;k++)
									{
										for (j=0;j<k;j++)
										{
											safeAddBaseline(k,j,doaddbaseline);
										}
									}
								}else //then eg 3x or 3;4;5x
								{
									scterm=xterm[0].split(';')
									for (sc=0;sc<scterm.length;sc++)
									{
									val=scterm[sc].valueOf()-antennamappingmode;
									if (val>=0&&val<antposx.length)
									{
										for (j=0;j<val;j++)
										{
											safeAddBaseline(val,j,doaddbaseline);
										}
										for (j=val+1;j<antposx.length;j++)
										{
											safeAddBaseline(val,j,doaddbaseline);
										}
									}else alert(''+(val+antennamappingmode)+' is not a valid antenna number')
									}
								}
							}else//only specific crosscorrelation
							{
								if (xterm[0]=='')// eg x4 or x4;6;7
								{
									scterm=xterm[1].split(';')
									for (sc=0;sc<scterm.length;sc++)
									{
									val=scterm[sc].valueOf()-antennamappingmode;
									if (val>=0&&val<antposx.length)
									{
										for (j=0;j<val;j++)
										{
											safeAddBaseline(val,j,doaddbaseline);
										}
										for (j=val+1;j<antposx.length;j++)
										{
											safeAddBaseline(val,j,doaddbaseline);
										}
									}else alert(''+(val+antennamappingmode)+' is not a valid antenna number')
									}
								}else
								{
									scterm0=xterm[0].split(';')
									scterm1=xterm[1].split(';')
									for (sc0=0;sc0<scterm0.length;sc0++)
									{
									val0=scterm0[sc0].valueOf()-antennamappingmode;
									if (val0>=0&&val0<antposx.length)
									for (sc1=0;sc1<scterm1.length;sc1++)
									{
										val1=scterm1[sc1].valueOf()-antennamappingmode;
										if (val1>=0&&val1<antposx.length)
										{
											safeAddBaseline(val0,val1,doaddbaseline);
										}else alert(''+(val1+antennamappingmode)+' is not a valid antenna number')
									}else alert(''+(val0+antennamappingmode)+' is not a valid antenna number')
								  	}
								}
							}
						}else alert('Error in expression: '+baselines[i])
					}else//is eg 9..11
					{
						if (term[0]=='')
						{
							if (term[1]=='')
							{//all auto corrs
								for (j=0;j<antposx.length;j++)
								{
									safeAddBaseline(j,j,doaddbaseline);
								}
							}else
							{
								val1=term[1].valueOf()-antennamappingmode;
								for (j=0;j<=val1;j++)
								{
									safeAddBaseline(j,j,doaddbaseline);
								}
							}						
						}else if (term[1]=='')
						{
							val0=term[0].valueOf()-antennamappingmode;
							for (j=val0;j<antposx.length;j++)
							{
								safeAddBaseline(j,j,doaddbaseline);
							}
						}else
						{
							val0=term[0].valueOf()-antennamappingmode;
							val1=term[1].valueOf()-antennamappingmode;
							if (val0>=0&&val0<antposx.length&&val1>=0&&val1<antposx.length)
							{
								for (j=val0;j<=val1;j++)
									safeAddBaseline(j,j,doaddbaseline);
							}else alert(''+(val0+antennamappingmode)+' or '+(val1+antennamappingmode)+' is not a valid antenna number')
						}
					}	
				}
			 	var plot_str="setbaseline"+",";
				for (j=0;j<antbase0.length;j++)
				{
					plot_str+=antbase0[j]+","
					plot_str+=antbase1[j]+","
				}
			 	handle_user_event(plot_str,0);
				redrawCanvas()
				return;
			}
			function selectAllX(){
				var nantbase0=[]
				var nantbase1=[]
				var alreadyhascross=false;
				for(i=0;i<antbase0.length;i++)
				{
					if (antbase0[i]==antbase1[i])
					{
						nantbase0[nantbase0.length]=antbase0[i];
						nantbase1[nantbase1.length]=antbase1[i];
					}else
					{
						alreadyhascross=true;
					}
				}
				if (alreadyhascross==false)
				{
					for(i=0;i<antposx.length;i++)
					{
						if (!antdisp[i])continue;
						for(j=0;j<i;j++)
						{
							if (!antdisp[j])continue;
							nantbase0[nantbase0.length]=j;
							nantbase1[nantbase1.length]=i;
						}
					}
				}//else remove cross instead
				antbase0=nantbase0;
				antbase1=nantbase1;
			 	var plot_str="setbaseline"+",";
				for (j=0;j<antbase0.length;j++)
				{
					plot_str+=antbase0[j]+","
					plot_str+=antbase1[j]+","
				}
			 	handle_user_event(plot_str,0);
				redrawCanvas()
			}
			function selectAllA(){
				var nantbase0=[]
				var nantbase1=[]
				var alreadyhasauto=false;
				for(i=0;i<antbase0.length;i++)
				{
					if (antbase0[i]!=antbase1[i])
					{
						nantbase0[nantbase0.length]=antbase0[i];
						nantbase1[nantbase1.length]=antbase1[i];
					}else
					{
						alreadyhasauto=true;
					}
				}
				if (alreadyhasauto==false)
				{
				 	for(i=0;i<antposx.length;i++)
					{
						if (!antdisp[i])continue;
						nantbase0[nantbase0.length]=i;
						nantbase1[nantbase1.length]=i;
					}
		  	    }//otherwise remove auto instead
				antbase0=nantbase0;
				antbase1=nantbase1;
			 	var plot_str="setbaseline"+",";
				for (j=0;j<antbase0.length;j++)
				{
					plot_str+=antbase0[j]+","
					plot_str+=antbase1[j]+","
				}
			 	handle_user_event(plot_str,0);
				redrawCanvas()
			}
			function applyToAll(){
			 	handle_user_event("applytoall",0);
			}
			function onMouseUp(event){
				for (i=0;i<antposx.length;i++)
				{
					if (!antdisp[i])continue;
					if ((antposx[i]-event.offsetX)*(antposx[i]-event.offsetX)+(antposy[i]-event.offsetY)*(antposy[i]-event.offsetY)<5*5)
					{
						if (antdown>=0)
						{
							antup=i;
							toggleBaseline(antdown,antup);
							return;
						}
					}
					for (j=0;j<i;j++)
					{
//						for(ii=0;ii<antbase0.length;ii++)
						{
//							if ((i==antbase0[ii]&&j==antbase1[ii]) || (j==antbase0[ii]&&i==antbase1[ii]))
							{
								if (!antdisp[j])continue;
								dx=antposx[j]-antposx[i];
								dy=antposy[j]-antposy[i];
								d=(((event.offsetX-antposx[i])*dy-(event.offsetY-antposy[i])*dx)/Math.sqrt((dx*dx)+(dy*dy)));
								t=(((event.offsetX-antposx[i])*dx+(event.offsetY-antposy[i])*dy)/((dx*dx)+(dy*dy)));
								if (t>0 && t<1 && d<2 && d>-2)
								{
									antup=i;
									antdown=j;
									toggleBaseline(antdown,antup);
									return;
								}
							}
						}
					}
				}
				return;
			}
			function onMouseMove(event){
				for (i=0;i<antposx.length;i++)
				{
					if (!antdisp[i])continue;
					if ((antposx[i]-event.offsetX)*(antposx[i]-event.offsetX)+(antposy[i]-event.offsetY)*(antposy[i]-event.offsetY)<5*5)
					{
						document.body.style.cursor = 'pointer';
						return;
					}
					for (j=0;j<i;j++)
					{
//						for(ii=0;ii<antbase0.length;ii++)
						{
//							if ((i==antbase0[ii]&&j==antbase1[ii]) || (j==antbase0[ii]&&i==antbase1[ii]))
							{
								if (!antdisp[j])continue;
								dx=antposx[j]-antposx[i];
								dy=antposy[j]-antposy[i];
								d=(((event.offsetX-antposx[i])*dy-(event.offsetY-antposy[i])*dx)/Math.sqrt((dx*dx)+(dy*dy)));
								t=(((event.offsetX-antposx[i])*dx+(event.offsetY-antposy[i])*dy)/((dx*dx)+(dy*dy)));
								if (t>0 && t<1 && d<2 && d>-2)
								{
									document.body.style.cursor = 'pointer';
									return;
								}
							}
						}
					}
				}
				document.body.style.cursor = 'default';
				return;
			}
			function onMouseOut(event){
				document.body.style.cursor = 'default';
				return;
			}
			function nextchunk(){
				handle_user_event("nextchunk",0);
			}
			function prevchunk(){
				handle_user_event("prevchunk",0);
			}
			function showhideControls(){
				controls=document.getElementById('controls');
				if (controls.style.display=='none')
					controls.style.display='block';
				else
					controls.style.display='none';
			}
			function showcsv(){
				document.getElementById('textflagdiv').style.display='none';
				document.getElementById('inputcsvdiv').style.display='block';
				document.getElementById('showcsvlegend').innerHTML="Flag <small>(<A HREF='#' onClick='hidecsv();'>cancel</A>)</small>:";
			}
			function hidecsv(){
				document.getElementById('textflagdiv').style.display='block';
				document.getElementById('inputcsvdiv').style.display='none';
				document.getElementById('showcsvlegend').innerHTML="Flag <small>(<A HREF='#' onClick='showcsv();'>from file</A>)</small>:";
			}
			 function handleinputcsv(files) {
			  var file = files[0];
			  var reader = new FileReader();
			  reader.onload = function(evt) { document.getElementById("textflag").value=evt.target.result;setflags(); }
			  reader.readAsText(file);
			  document.getElementById('inputcsv').value="";
			  hidecsv()
			 }
			function saveFigure(){
				var canvas = document.getElementById("canvas_0");
				var context = canvas.getContext("2d");
				var img     = canvas.toDataURL("image/png");
				var heading=document.getElementById("saveid")
				//saveid.firstChild.nodeValue="hello"
				//	document.write('<img src="'+img+'"/>');
//				self.location=img;
				window.open(img);
			}
			function onMouseCanvasDown(event){
				if (event.altKey && (event.srcElement.id=="limit_div_0_0" || event.srcElement.id=="limit_div_1_0")){
					var posx=event.layerX/event.srcElement.style.width.substring(0,event.srcElement.style.width.length-2)
				 	handle_user_event("settimeinstant"+","+posx+",",0);
				}
			}
			function onChangeTypemenu(txtid1,txtid2){
				var txt1=document.getElementById(txtid1);
				var txt2=document.getElementById(txtid2);
				txt1.value=''
				txt2.value=''
				plot()
			}
			function onChangeMinMax(textid,othertextid,min0max1){
				var textctl	= document.getElementById(textid);
				var othertextctl= document.getElementById(othertextid);
				txt=textctl.value;
				othertxt=othertextctl.value;
				var rng=txt.split('..');
				if (rng.length==1)
				{
					if (isNaN(rng))
					{
						alert ("Error in expression: "+rng)
						return
					}
					if (min0max1==0)
						rng=[txt,othertxt];
					else
						rng=[othertxt,txt];
					if (rng[0]=='' || rng[1]=='' || parseFloat(rng[0])<parseFloat(rng[1]))
					{
						textctl.value=rng[min0max1]
						othertextctl.value=rng[1-min0max1]
					}else
					{
						textctl.value=rng[1-min0max1]
						othertextctl.value=rng[min0max1]
					}					
				}else if (rng.length==2)
				{
					if (isNaN(rng[0]) || isNaN(rng[1]))
					{
						alert ("Error in expression: "+rng)
						return
					}
					if (rng[0]=='' || rng[1]=='' || parseFloat(rng[0])<parseFloat(rng[1]))
					{
						textctl.value=rng[min0max1]
						othertextctl.value=rng[1-min0max1]
					}else
					{
						textctl.value=rng[1-min0max1]
						othertextctl.value=rng[min0max1]
					}
				}else 
				{
					alert ("Error in expression: "+rng)
					return;
				}
				plot()
			}
			function combinehms(hh,mm,ss,sec){
				rv=''
				time=hh*60*60+mm*60+ss+sec;
				hh=Math.floor(time/(60*60));
				if (hh<10)
					rv+='0'
				rv+=hh+':'
				mm=Math.floor((time-hh*60*60)/60);
				if (mm<10)
					rv+='0'
				rv+=mm+':'
				ss=(time-hh*60*60-mm*60);
				if (ss<10)
					rv+='0'
				rv+=ss;
				return rv
			}
			//03:33:00	returns [03:33:00,'']
			//-30 returns [-30,'']
			//03:33:00-10  returns [03:32:50,03:33:00]
			//03:32:45..03:33:00 returns [03:32:45,03:33:00]
			//-30..-5	returns [-30,-5]
			//special function to handle hh:mm:ss format
			function onChangeMinMaxTime(textid,othertextid,min0max1){
				var textctl	= document.getElementById(textid);
				var othertextctl= document.getElementById(othertextid);
				txt=textctl.value;
				othertxt=othertextctl.value;
				rng=txt.split('..')
				if (rng.length==1)//ie 03:33:00 or -30 or 03:33:00-10
				{
					rng=txt.split('-')
					if (rng.length==2&&rng[0].split(':').length==3&&!isNaN(rng[1]))// 03:33:00-10
					{
						hms=rng[0].split(':');
						cv=[combinehms(parseFloat(hms[0]),parseFloat(hms[1]),parseFloat(hms[2]),-parseFloat(rng[1])),rng[0]]
						textctl.value=cv[min0max1]
						othertextctl.value=cv[1-min0max1]
						plot()
						return;
					}
					rng=txt.split('+')
					if (rng.length==2&&rng[0].split(':').length==3&&!isNaN(rng[1]))// 03:33:00+10
					{
						hms=rng[0].split(':');
						cv=[rng[0],combinehms(parseFloat(hms[0]),parseFloat(hms[1]),parseFloat(hms[2]),parseFloat(rng[1]))]
						textctl.value=cv[min0max1]
						othertextctl.value=cv[1-min0max1]
						plot()
						return
					}				
					hms=txt.split(':')
					if (hms.length==3&&!isNaN(hms[0])&&!isNaN(hms[1])&&!isNaN(hms[2]))// 03:33:00
					{
						textctl.value=txt;
						plot()
						return
					}else if (hms.length==1&&!isNaN(hms[0]))//-20
					{
						textctl.value=txt;
						plot()
						return
					}
				}else if (rng.length==2)// 03:33:00.. 03:33:10 or -30..-20
				{
					textctl.value=rng[min0max1]
					othertextctl.value=rng[1-min0max1]
					plot()
					return;
				}
				alert ("Error in expression: "+txt)
			}
		</script>
		<div align="left" style="position: relative; left:5px; top:0px;"> 
		<small>
		<b>Time series</b> <A HREF="figure2">Spectrum</A> <A HREF="figure3">Waterfall</A> <A HREF="figure4">Baseline matrix</A> <element id="healthtext"> </element>
		</small>
		</div>
		<div align="right" style="position: absolute; right:5px; top:6px"> 
		<small>
			<A id="prevchunkid" HREF="#" onClick="prevchunk();" style="display:none">prev</A> <A id="nextchunkid" HREF="#" onClick="nextchunk();" style="display:none">next</A> <A id="saveid" HREF="#" onClick="saveFigure();">png</A> <A HREF="#" onClick="showhideControls();">Controls</A> <A HREF="figure5">Help</A>
		</small>
		</div>
	<div id="controls" align="left" style="position: relative;">
		<small>
		<table>
		<tr>
		<td>
		<small>
		<fieldset style="width:285px;height:140px;">
		<legend>Select baselines:</legend>		
		<table>
		    <td>
				<div align="center">
					<ELEMENT onmousedown = "onMouseDown(event);" onmouseup = "onMouseUp(event);" onmousemove = "onMouseMove(event);" onmouseout = "onMouseOut(event);">
					<canvas style="border: 1px solid #d0d0d0;" id="antennaCanvas" width="122" height="122">
					<p>Your browser doesn't support canvas.</p>
					</canvas>
				</div>
			</td>
		    <td><small>

				<input type="text" id="textselectbaseline" placeholder="eg: 1x2,4..6,3x,!3x2,!3" value="" size=25 onChange="selectBaseline()"><br>
				<input type="button" id="buttonAllA" value="Auto"  onClick="selectAllA()">
				<input type="button" id="buttonAllX" value="Cross"  onClick="selectAllX()">
				<input type="button" id="buttonClear" value="Clear" onClick="selectClear()"><br>
				<div style="height:6px"></div>
				&nbsp;<input type="checkbox" id="optionHH" value="HH" onChange="plot()"><element id="HHtext">HH</element><canvas id="canvasThick" width="24" height="10"><p>Your browser doesn't support canvas.</p></canvas>&nbsp;&nbsp;
				<input type="checkbox" id="optionHV" value="HV" onChange="plot()"><element id="HVtext">HV</element><canvas id="canvasDash" width="24" height="10"><p>Your browser doesn't support canvas.</p></canvas><br>
				<div style="height:1px"></div>
				&nbsp;<input type="checkbox" id="optionVV" value="VV" onChange="plot()"><element id="VVtext">VV</element><canvas id="canvasThin" width="24" height="10"><p>Your browser doesn't support canvas.</p></canvas>&nbsp;&nbsp;
				<input type="checkbox" id="optionVH" value="VH" onChange="plot()"><element id="VHtext">VH</element><canvas id="canvasDot" width="24" height="10"><p>Your browser doesn't support canvas.</p></canvas><br><br>
				<center><input type="button" id="buttonApplyToAll" value="Apply to all" checked onClick="applyToAll()"></center>
				</small>
			</td>
		</table>
		</fieldset>
		</small>
		</td>
		<td>
		<small>
		<fieldset style="width:260px;height:90px;">
		<legend>Display:</legend>
		<table>
			<td>
				<select id="typemenu" name="typemenu" onChange="onChangeTypemenu('textminF','textmaxF')">
				<option selected value="pow">Power</option>
				<option value="mag">Amplitude</option>
				<option value="phase">Phase</option>
				<option value="powphase">P & Ph</option>
			</select>
			</td>
			<td align='right'><small>
				<input type="text" id="textminF" placeholder="min" value=""  size=10 onChange="onChangeMinMax('textminF','textmaxF',0)">
			</small></td>
			<td align='right'><small>
				<input type="text" id="textmaxF" placeholder="max" value="" size=10 onChange="onChangeMinMax('textmaxF','textminF',1)">
			</small></td>
		<tr>
			<td><small>
				&nbsp;Time or Delay
		    </small></td>
			<td align='right'><small>
				<input type="text" id="textminx" placeholder="min" value=""  size=10 onChange="onChangeMinMaxTime('textminx','textmaxx',0)">
			</small></td>
			<td align='right'><small>
				<input type="text" id="textmaxx" placeholder="max" value="" size=10 onChange="onChangeMinMaxTime('textmaxx','textminx',1)">
			</small></td>
		<tr>
			<td><small>
				<input type="checkbox" id="optionlegend" value="legend" onChange="plot()"> legend
			</small></td>
			<td align='right'><small>
				<input type="text" id="textchannelphase" placeholder="chan phase" value="" size=10 onChange="settextchannelphase()">
			</small></td>
			<td align='right'><small>
				<input type="text" id="texttimeavg" placeholder="dump avg" value="" size=10 onChange="plot()">
			</small></td>
		</table>
		</fieldset>
		<fieldset style="width:260px;height:34px;">
		<legend id="showcsvlegend">Flag <small>(<A HREF="#" onClick="showcsv();">from file</A>)</small>:</legend>
			<div id="textflagdiv"><input type="text" placeholder="channels, eg: ..100,120,130..150,-100.." id="textflag" value="" size=46 onChange="setflags()"></div>
			<div id=inputcsvdiv style="display:none"><input type="file" name="csv" id="inputcsv" placeholder="csv" onchange="handleinputcsv(this.files)"></div>
		</fieldset>
		</small>
		</td>
	</table>
	</small>
	</div>
	<div style="position: relative;"><ELEMENT onmousedown = "onMouseCanvasDown(event);"><!--figure--></div>
