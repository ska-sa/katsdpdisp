<html>
<head>
<title>KAT7 signals</title> 
</head>
<body onload='myloadpage()' bgcolor="#FFFFFF">
	<script>
	function plot(){
	 var selcheckHH = document.getElementById("optionHH");
	 var selcheckVV = document.getElementById("optionVV");
	 var selcheckHV = document.getElementById("optionHV");
	 var selcheckVH = document.getElementById("optionVH");
	 var seltypemenu = document.getElementById("typemenu");
	 var textminF	= document.getElementById("textminF");
	 var textmaxF	= document.getElementById("textmaxF");
	 var seltypemenux= document.getElementById("typemenux");
	 var textminx	= document.getElementById("textminx");
	 var textmaxx	= document.getElementById("textmaxx");
	 var textminy	= document.getElementById("textminy");
	 var textmaxy	= document.getElementById("textmaxy");
	 var plot_str="";
	 plot_str+=selcheckHH.checked+","
	 plot_str+=selcheckVV.checked+","
	 plot_str+=selcheckHV.checked+","
	 plot_str+=selcheckVH.checked+","
	 plot_str+=""+","
	 plot_str+=seltypemenu.options[seltypemenu.selectedIndex].value+","
	 plot_str+=textminF.value+","
	 plot_str+=textmaxF.value+","
	 plot_str+=seltypemenux.options[seltypemenux.selectedIndex].value+","
	 plot_str+=textminx.value+","
	 plot_str+=textmaxx.value+","
	 plot_str+=""+","
	 plot_str+=textminy.value+","
	 plot_str+=textmaxy.value
	 plot_str+=""+","
	 plot_str+=""
	 handle_user_event(plot_str,0);
	}
			var antbase0=[];
			var antbase1=[];
			var antennamappingmode=<!--antennamappingmode-->
			var antposx=<!--antposx-list-->
			var antposy=<!--antposy-list-->
			var antdisp=<!--antdisp-list-->
			var antposminx=1e30;
			var antposminy=1e30;
			var antposmaxx=-1e30;
			var antposmaxy=-1e30;
			var nvalidant=0;
			for (i=0;i<antposx.length;i++)
			{
				if (!antdisp[i])continue;
				if (antposx[i]<antposminx)antposminx=antposx[i];
				if (antposx[i]>antposmaxx)antposmaxx=antposx[i];
				if (antposy[i]<antposminy)antposminy=antposy[i];
				if (antposy[i]>antposmaxy)antposmaxy=antposy[i];
				nvalidant++;
			}
			if (nvalidant>1)
			for (i=0;i<antposx.length;i++)
			{
				antposx[i]=(antposx[i]-antposminx)/(antposmaxx-antposminx)*100+6+5;
				antposy[i]=(1-(antposy[i]-antposminy)/(antposmaxy-antposminy))*100+6;
			}else
			for(i=0;i<antposx.length;i++)
			{
				antposx[i]=50;
				antposy[i]=50;
			}
			var antdown=-1;
			var antup=-1;
			
			function myloadpage(){
				connect_manager();
			//beginloadpage
			//endloadpage
			}
			
			function redrawCanvas(){
			var colourlist=<!--colour-list>
			var drawingCanvas = document.getElementById('antennaCanvas');
			if(drawingCanvas.getContext) {
			var context = drawingCanvas.getContext('2d');
			context.fillStyle = "#FFFFFF";
			context.fillRect(0, 0, 150, 150);
			context.font="12px sans-serif";
			context.strokeStyle = "#000000";
			context.fillStyle = "#000000";
			for (i=0;i<antposx.length;i++)
			{
				if (!antdisp[i])continue;
				context.beginPath();
				context.arc(antposx[i],antposy[i],5,0,Math.PI*2,true);
				context.closePath();
				context.stroke();
			}
			for (i=0;i<antbase0.length;i++)
			{
				context.strokeStyle = colourlist[i%colourlist.length];
				context.beginPath();
				if (antbase0[i]==antbase1[i])
				{
					context.lineWidth   = 1
					context.fillStyle=colourlist[i%colourlist.length];
					context.arc(antposx[antbase0[i]],antposy[antbase1[i]],5,0,Math.PI*2,true);
				}else
				{
					context.lineWidth   = 2
					context.moveTo(antposx[antbase0[i]],antposy[antbase0[i]]);
					context.lineTo(antposx[antbase1[i]],antposy[antbase1[i]]);
				}
				context.closePath();
				context.stroke();
				context.fill();
			}
			context.lineWidth   = 1
			context.fillStyle="#000000"
			for (i=0;i<antposx.length;i++)
			{
				if (!antdisp[i])continue;
				context.fillText(i+antennamappingmode,antposx[i]-3,antposy[i]+15);
			}
			}
			}
			function onMouseDown(event){
				antup=-1;
				for (i=0;i<antposx.length;i++)
				{
					if (!antdisp[i])continue;
					if ((antposx[i]-event.offsetX)*(antposx[i]-event.offsetX)+(antposy[i]-event.offsetY)*(antposy[i]-event.offsetY)<5*5)
					{
						antdown=i;
						return;
					}
				}
				antdown=-1;
				return;
			}
			function toggleBaseline(ant0,ant1){
				if (ant1<ant0)
				{
					var ant=ant1;
					ant1=ant0;
					ant0=ant;
				}
				var removed=false;
				for(i=0;i<antbase0.length;i++)
				{
					if ((ant0==antbase0[i]&&ant1==antbase1[i]) || (ant1==antbase0[i]&&ant0==antbase1[i]))
					{
						antbase0.splice(i,1);
						antbase1.splice(i,1);
						removed=true;
						break;
					}
				}
				if (!removed)
				{
				   antbase0[antbase0.length]=ant0;
				   antbase1[antbase1.length]=ant1;
			    }
			 	var plot_str="setbaseline"+",";
				for (j=0;j<antbase0.length;j++)
				{
					plot_str+=antbase0[j]+","
					plot_str+=antbase1[j]+","
				}
			 	handle_user_event(plot_str,0);
				redrawCanvas()
				return;
			}
			function addBaseline(ant0,ant1){
				if (ant1<ant0)
				{
					var ant=ant1;
					ant1=ant0;
					ant0=ant;
				}
				for(ii=0;ii<antbase0.length;ii++)
				{
					if ((ant0==antbase0[ii]&&ant1==antbase1[ii]) || (ant1==antbase0[ii]&&ant0==antbase1[ii]))
					{
						return;//already in list
					}
				}
				if (ii==antbase0.length)
				{
				   antbase0[antbase0.length]=ant0;
				   antbase1[antbase1.length]=ant1;
			    }
				return;
			}
			function safeAddBaseline(ant0,ant1,doaddbaseline){
				rv=[]
				if (ant0<0||ant0>=antdisp.length||!antdisp[ant0]) rv[rv.length]=ant0;
				if (ant1<0||ant1>=antdisp.length||!antdisp[ant1]) rv[rv.length]=ant1;
				if (rv.length) return rv;
				addBaseline(ant0,ant1,doaddbaseline)
				return rv;
			}
			function selectClear(){
				antbase0=[];
				antbase1=[];
			 	var plot_str="setbaseline"+",";
			 	handle_user_event(plot_str,0);
				redrawCanvas()
			}
			function selectBaseline(){
				var textbaseline= document.getElementById("textselectbaseline");
				//first convert , to ; if inside brackets and convert - to items separated by ; also remove brackets also remove spaces
				var txt=textbaseline.value;
				var newtxt=''
				var inbrack=0;
				
				for (i=0;i<txt.length;i++)
				{
					if (txt[i]==' ')continue;
					if (txt[i]=='(')
					{
						if (inbrack)
						{
							alert('Nested brackets not allowed')
							return;
						}
						inbrack=1;
					}else
					if (txt[i]==')')
					{
						if (inbrack)
						{
							inbrack=0;
						}else
						{
							alert('Unexpected )')
							return;
						}
					}else
					if (inbrack)
					{
						if (txt[i]==',')
						{
							newtxt+=';'
						}else if (txt[i]=='.'&&(i+1)<txt.length&&txt[i+1]=='.')//..
						{
							//try determine range values
							valt0=''
							for (j=i-1;j>0;j--)
							{
								if (txt[j].split(/\d/).length!=2) break
								valt0=''+txt[j]+valt0;
							}
							if (valt0=='') val0=0
							else val0=valt0.valueOf()-antennamappingmode;
							valt1=''
							i++;
							for (j=i+1;j<txt.length;j++)
							{
								if (txt[j].split(/\d/).length!=2) break
								valt1+=txt[j];
							}
							if (valt1=='') val1=antposx.length-1;
							else val1=valt1.valueOf()-antennamappingmode;
							if (valt0=='')
								newtxt+=(val0+antennamappingmode);
							for (j=val0+1;j<val1;j++)
								newtxt+=';'+(j+antennamappingmode);
							if (valt1=='')
								newtxt+=';'+(val1+antennamappingmode);
							else newtxt+=';';
						}else newtxt+=txt[i]
					}else if (txt[i]==';')
					{
						newtxt+=',';
					}else newtxt+=txt[i];
				}
				var baselines=newtxt.split(',');
				var val,val0,val1;
				if (baselines=='')	return
				
				//eg 3,4,5,8..11,3x5,4x, !3,!3..5,!3x
				//autocorrelations 3,4,5,8..11
				//specific cross correlations 3x5
				//cross correlations to all other antennas 4x
				for (i=0;i<baselines.length;i++)
				{
					var doaddbaseline=0;
					var termremainder=baselines[i].split('!');
					if (termremainder.length!=2){
						doaddbaseline=1
						termremainder=baselines[i];
					}else{
						if (termremainder[0]=='')
							termremainder=termremainder[1]
						else termremainder=termremainder[0]
					}
					var term=termremainder.split('..');
					if (term.length==1)//not range
					{
						var xterm=termremainder.split('x');
						if (xterm.length==1)//eg 3
						{
							scterm=termremainder.split(';')
							for (sc=0;sc<scterm.length;sc++)
							{
								val=scterm[sc].valueOf()-antennamappingmode;
								if (val>=0&&val<antposx.length)
								{
									safeAddBaseline(val,val,doaddbaseline);
								}else alert(''+(val+antennamappingmode)+' is not a valid antenna number')
							}
						}else if(xterm.length==2)
						{
							if (xterm[1]=='')
							{//then all cross correlations of xterm[0]
								if (xterm[0]=='')
								{//then all cross correlations
									for (k=0;k<antposx.length;k++)
									{
										for (j=0;j<k;j++)
										{
											safeAddBaseline(k,j,doaddbaseline);
										}
									}
								}else //then eg 3x or 3;4;5x
								{
									scterm=xterm[0].split(';')
									for (sc=0;sc<scterm.length;sc++)
									{
									val=scterm[sc].valueOf()-antennamappingmode;
									if (val>=0&&val<antposx.length)
									{
										for (j=0;j<val;j++)
										{
											safeAddBaseline(val,j,doaddbaseline);
										}
										for (j=val+1;j<antposx.length;j++)
										{
											safeAddBaseline(val,j,doaddbaseline);
										}
									}else alert(''+(val+antennamappingmode)+' is not a valid antenna number')
									}
								}
							}else//only specific crosscorrelation
							{
								if (xterm[0]=='')// eg x4 or x4;6;7
								{
									scterm=xterm[1].split(';')
									for (sc=0;sc<scterm.length;sc++)
									{
									val=scterm[sc].valueOf()-antennamappingmode;
									if (val>=0&&val<antposx.length)
									{
										for (j=0;j<val;j++)
										{
											safeAddBaseline(val,j,doaddbaseline);
										}
										for (j=val+1;j<antposx.length;j++)
										{
											safeAddBaseline(val,j,doaddbaseline);
										}
									}else alert(''+(val+antennamappingmode)+' is not a valid antenna number')
									}
								}else
								{
									scterm0=xterm[0].split(';')
									scterm1=xterm[1].split(';')
									for (sc0=0;sc0<scterm0.length;sc0++)
									{
									val0=scterm0[sc0].valueOf()-antennamappingmode;
									if (val0>=0&&val0<antposx.length)
									for (sc1=0;sc1<scterm1.length;sc1++)
									{
										val1=scterm1[sc1].valueOf()-antennamappingmode;
										if (val1>=0&&val1<antposx.length)
										{
											safeAddBaseline(val0,val1,doaddbaseline);
										}else alert(''+(val1+antennamappingmode)+' is not a valid antenna number')
									}else alert(''+(val0+antennamappingmode)+' is not a valid antenna number')
								  	}
								}
							}
						}else alert('Error in expression: '+baselines[i])
					}else//is eg 9..11
					{
						if (term[0]=='')
						{
							if (term[1]=='')
							{//all auto corrs
								for (j=0;j<antposx.length;j++)
								{
									safeAddBaseline(j,j,doaddbaseline);
								}
							}else
							{
								val1=term[1].valueOf()-antennamappingmode;
								for (j=0;j<=val1;j++)
								{
									safeAddBaseline(j,j,doaddbaseline);
								}
							}						
						}else if (term[1]=='')
						{
							val0=term[0].valueOf()-antennamappingmode;
							for (j=val0;j<antposx.length;j++)
							{
								safeAddBaseline(j,j,doaddbaseline);
							}
						}else
						{
							val0=term[0].valueOf()-antennamappingmode;
							val1=term[1].valueOf()-antennamappingmode;
							if (val0>=0&&val0<antposx.length&&val1>=0&&val1<antposx.length)
							{
								for (j=val0;j<=val1;j++)
									safeAddBaseline(j,j,doaddbaseline);
							}else alert(''+(val0+antennamappingmode)+' or '+(val1+antennamappingmode)+' is not a valid antenna number')
						}
					}	
				}
			 	var plot_str="setbaseline"+",";
				for (j=0;j<antbase0.length;j++)
				{
					plot_str+=antbase0[j]+","
					plot_str+=antbase1[j]+","
				}
			 	handle_user_event(plot_str,0);
				redrawCanvas()
				return;
			}
			function selectAllX(){
				var nantbase0=[]
				var nantbase1=[]
				var alreadyhascross=false;
				for(i=0;i<antbase0.length;i++)
				{
					if (antbase0[i]==antbase1[i])
					{
						nantbase0[nantbase0.length]=antbase0[i];
						nantbase1[nantbase1.length]=antbase1[i];
					}else
					{
						alreadyhascross=true;
					}
				}
				if (alreadyhascross==false)
				{
					for(i=0;i<antposx.length;i++)
					{
						if (!antdisp[i])continue;
						for(j=0;j<i;j++)
						{
							if (!antdisp[j])continue;
							nantbase0[nantbase0.length]=j;
							nantbase1[nantbase1.length]=i;
						}
					}
				}//else remove cross instead
				antbase0=nantbase0;
				antbase1=nantbase1;
			 	var plot_str="setbaseline"+",";
				for (j=0;j<antbase0.length;j++)
				{
					plot_str+=antbase0[j]+","
					plot_str+=antbase1[j]+","
				}
			 	handle_user_event(plot_str,0);
				redrawCanvas()
			}
			function selectAllA(){
				var nantbase0=[]
				var nantbase1=[]
				var alreadyhasauto=false;
				for(i=0;i<antbase0.length;i++)
				{
					if (antbase0[i]!=antbase1[i])
					{
						nantbase0[nantbase0.length]=antbase0[i];
						nantbase1[nantbase1.length]=antbase1[i];
					}else
					{
						alreadyhasauto=true;
					}
				}
				if (alreadyhasauto==false)
				{
				 	for(i=0;i<antposx.length;i++)
					{
						if (!antdisp[i])continue;
						nantbase0[nantbase0.length]=i;
						nantbase1[nantbase1.length]=i;
					}
		  	    }//otherwise remove auto instead
				antbase0=nantbase0;
				antbase1=nantbase1;
			 	var plot_str="setbaseline"+",";
				for (j=0;j<antbase0.length;j++)
				{
					plot_str+=antbase0[j]+","
					plot_str+=antbase1[j]+","
				}
			 	handle_user_event(plot_str,0);
				redrawCanvas()
			}
			function applyToAll(){
			 	handle_user_event("applytoall",0);
			}
			function onMouseUp(event){
				if (antdown<0)
				{
					return;
				}
				antbase0=[];
				antbase1=[];
				for (i=0;i<antposx.length;i++)
				{
					if (!antdisp[i])continue;
					if ((antposx[i]-event.offsetX)*(antposx[i]-event.offsetX)+(antposy[i]-event.offsetY)*(antposy[i]-event.offsetY)<5*5)
					{
						antup=i;
						toggleBaseline(antdown,antup);
						return;
					}
				}
				return;
			}
			function onMouseMove(event){
				for (i=0;i<antposx.length;i++)
				{
					if (!antdisp[i])continue;
					if ((antposx[i]-event.offsetX)*(antposx[i]-event.offsetX)+(antposy[i]-event.offsetY)*(antposy[i]-event.offsetY)<5*5)
					{
						document.body.style.cursor = 'pointer';
						return;
					}
				}
				document.body.style.cursor = 'default';
				return;
			}
			function onMouseOut(event){
				document.body.style.cursor = 'default';
				return;
			}
			function showhideControls(){
				controls=document.getElementById('controls');
				if (controls.style.display=='none')
					controls.style.display='block';
				else
					controls.style.display='none';
			}
			function saveFigure(){
				var canvas = document.getElementById("canvas_0");
				var context = canvas.getContext("2d");
				var img     = canvas.toDataURL("image/png");
				var heading=document.getElementById("saveid")
				//saveid.firstChild.nodeValue="hello"
				//	document.write('<img src="'+img+'"/>');
//				self.location=img;
				window.open(img);
			}
	</script>
	<div align="left" style="position: relative; left:5px; top:0px"> 
	<small>
	<A HREF="figure1">Time series</A> <A HREF="figure2">Spectrum</A> <A HREF="figure3">Waterfall</A> <b>Baseline matrix</b> <element id="healthtext"> </element>
	</small>
	</div>	
	<div align="right" style="position: absolute; right:5px; top:6px"> 
	<small>
		<A id="saveid" HREF="#" onClick="saveFigure();">png</A> <A HREF="#" onClick="showhideControls();">Controls</A> <A HREF="figure5">Help</A>
	</small>
	</div>
	<div style="position: relative;"><!--figure--></div>
